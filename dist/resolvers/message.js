"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _models = require("../models");

var _apolloServerExpress = require("apollo-server-express");

var _graphqlSubscriptions = require("graphql-subscriptions");

const pubsub = new _apolloServerExpress.PubSub();
const MESSAGE_SUBSCRIPTIONS = {
  ADD: 'MESSAGE_ADDED',
  UPDATE: 'MESSAGE_UPDATED',
  DELETE: 'MESSAGE_DELETED'
};
const MessageResolve = {
  Query: {
    getMessages: async (root, {
      chatId,
      limit,
      fromMessage
    }, {
      user
    }) => {
      const chat = (await _models.Chat.findChat({
        _id: chatId
      })).userInMembers(user);

      const getOffset = async () => {
        const messages = await _models.Message.find({
          chatId
        }).sort({
          createdAt: -1
        });
        const idx = messages.findIndex(message => message._id.toString() === fromMessage);
        if (idx === -1) throw new _apolloServerExpress.ApolloError("");
        return idx + 1;
      };

      const offset = fromMessage ? await getOffset() : 0;
      const messages = await _models.Message.find({
        chatId
      }).sort({
        createdAt: -1
      }).limit(limit).skip(offset);
      return messages.sort((a, b) => Number(a.createdAt) - Number(b.createdAt));
    }
  },
  Mutation: {
    sendMessage: async (root, args, {
      user
    }) => {
      const message = await _models.Message.create({ ...args,
        sender: user,
        viewedBy: [user]
      });
      pubsub.publish(MESSAGE_SUBSCRIPTIONS.ADD, {
        type: 'ADD',
        message
      });
      return message;
    },
    deleteMessage: async (root, {
      id
    }, {
      user
    }) => {
      const message = (await _models.Message.findMessage({
        _id: id
      })).haveSenderAllow(user);
      await _models.Message.deleteOne({
        _id: id
      });
      pubsub.publish(MESSAGE_SUBSCRIPTIONS.DELETE, {
        type: 'DELETE',
        message
      });
      return message;
    },
    updateMessage: async (root, {
      id,
      body
    }, {
      user
    }) => {
      const message = (await _models.Message.findMessage({
        _id: id
      })).haveSenderAllow(user);
      const updatedMessage = await _models.Message.findByIdAndUpdate(id, {
        body
      }, {
        new: true
      });
      pubsub.publish(MESSAGE_SUBSCRIPTIONS.UPDATE, {
        type: 'UPDATE',
        message
      });
      return updatedMessage;
    },
    markAsRead: async (root, {
      messageId
    }, {
      user
    }) => {
      await _models.Message.updateOne({
        _id: messageId
      }, {
        $push: {
          viewedBy: user
        }
      });
      return true;
    }
  },
  Message: {
    sender: async message => (await message.populate('sender').execPopulate()).sender,
    isViewed: ({
      viewedBy
    }, _, {
      user
    }) => viewedBy.includes(user)
  },
  Subscription: {
    messageObserver: {
      resolve: payload => payload,
      subscribe: (0, _graphqlSubscriptions.withFilter)((root, {
        types
      }) => {
        const subscriptions = types.map(type => MESSAGE_SUBSCRIPTIONS[type]);
        return pubsub.asyncIterator(subscriptions);
      }, async ({
        message
      }, _, {
        user
      }) => {
        const {
          members
        } = await _models.Chat.findChat({
          _id: message.chatId
        });
        const isMember = members.some(member => member.toString() === user);
        const {
          sender
        } = await message.populate('sender').execPopulate();
        const notSender = sender.id.toString() !== user;
        return isMember && notSender;
      })
    }
  }
};
var _default = MessageResolve;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yZXNvbHZlcnMvbWVzc2FnZS50cyJdLCJuYW1lcyI6WyJwdWJzdWIiLCJQdWJTdWIiLCJNRVNTQUdFX1NVQlNDUklQVElPTlMiLCJBREQiLCJVUERBVEUiLCJERUxFVEUiLCJNZXNzYWdlUmVzb2x2ZSIsIlF1ZXJ5IiwiZ2V0TWVzc2FnZXMiLCJyb290IiwiY2hhdElkIiwibGltaXQiLCJmcm9tTWVzc2FnZSIsInVzZXIiLCJjaGF0IiwiQ2hhdCIsImZpbmRDaGF0IiwiX2lkIiwidXNlckluTWVtYmVycyIsImdldE9mZnNldCIsIm1lc3NhZ2VzIiwiTWVzc2FnZSIsImZpbmQiLCJzb3J0IiwiY3JlYXRlZEF0IiwiaWR4IiwiZmluZEluZGV4IiwibWVzc2FnZSIsInRvU3RyaW5nIiwiQXBvbGxvRXJyb3IiLCJvZmZzZXQiLCJza2lwIiwiYSIsImIiLCJOdW1iZXIiLCJNdXRhdGlvbiIsInNlbmRNZXNzYWdlIiwiYXJncyIsImNyZWF0ZSIsInNlbmRlciIsInZpZXdlZEJ5IiwicHVibGlzaCIsInR5cGUiLCJkZWxldGVNZXNzYWdlIiwiaWQiLCJmaW5kTWVzc2FnZSIsImhhdmVTZW5kZXJBbGxvdyIsImRlbGV0ZU9uZSIsInVwZGF0ZU1lc3NhZ2UiLCJib2R5IiwidXBkYXRlZE1lc3NhZ2UiLCJmaW5kQnlJZEFuZFVwZGF0ZSIsIm5ldyIsIm1hcmtBc1JlYWQiLCJtZXNzYWdlSWQiLCJ1cGRhdGVPbmUiLCIkcHVzaCIsInBvcHVsYXRlIiwiZXhlY1BvcHVsYXRlIiwiaXNWaWV3ZWQiLCJfIiwiaW5jbHVkZXMiLCJTdWJzY3JpcHRpb24iLCJtZXNzYWdlT2JzZXJ2ZXIiLCJyZXNvbHZlIiwicGF5bG9hZCIsInN1YnNjcmliZSIsInR5cGVzIiwic3Vic2NyaXB0aW9ucyIsIm1hcCIsImFzeW5jSXRlcmF0b3IiLCJtZW1iZXJzIiwiaXNNZW1iZXIiLCJzb21lIiwibWVtYmVyIiwibm90U2VuZGVyIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7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RCxRQUFRLEdBQUdELE9BQU8sQ0FBQ0UsSUFBUixDQUFhQyxNQUFNLElBQUlBLE1BQU0sQ0FBQzlDLFFBQVAsT0FBc0JmLElBQTdDLENBQWpCO0FBRUEsY0FBTTtBQUFFMEIsVUFBQUE7QUFBRixZQUFhLE1BQU1aLE9BQU8sQ0FBQzhCLFFBQVIsQ0FBaUIsUUFBakIsRUFBMkJDLFlBQTNCLEVBQXpCO0FBRUEsY0FBTWlCLFNBQVMsR0FBR3BDLE1BQU0sQ0FBQ0ssRUFBUCxDQUFVaEIsUUFBVixPQUF5QmYsSUFBM0M7QUFFQSxlQUFPMkQsUUFBUSxJQUFJRyxTQUFuQjtBQUNELE9BckJRO0FBRkk7QUFETDtBQXZGbUIsQ0FBbkM7ZUFxSGVyRSxjIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ2hhdCwgTWVzc2FnZSB9IGZyb20gJy4uL21vZGVscydcclxuaW1wb3J0IHsgUHViU3ViLCBBcG9sbG9FcnJvciwgSVJlc29sdmVycywgVXNlcklucHV0RXJyb3IgfSBmcm9tICdhcG9sbG8tc2VydmVyLWV4cHJlc3MnXHJcbmltcG9ydCB7IHdpdGhGaWx0ZXIgfSBmcm9tICdncmFwaHFsLXN1YnNjcmlwdGlvbnMnXHJcbmltcG9ydCB7IFVzZXJEb2N1bWVudCwgTWVzc2FnZURvY3VtZW50IH0gZnJvbSAnLi4vdHlwZXMnXHJcblxyXG5jb25zdCBwdWJzdWIgPSBuZXcgUHViU3ViKClcclxuXHJcbmNvbnN0IE1FU1NBR0VfU1VCU0NSSVBUSU9OUyA9IHtcclxuICBBREQ6ICdNRVNTQUdFX0FEREVEJyxcclxuICBVUERBVEU6ICdNRVNTQUdFX1VQREFURUQnLFxyXG4gIERFTEVURTogJ01FU1NBR0VfREVMRVRFRCdcclxufVxyXG5cclxuY29uc3QgTWVzc2FnZVJlc29sdmU6IElSZXNvbHZlcnMgPSB7XHJcbiAgUXVlcnk6IHtcclxuICAgIGdldE1lc3NhZ2VzOiBhc3luYyAoXHJcbiAgICAgIHJvb3QsXHJcbiAgICAgIHsgY2hhdElkLCBsaW1pdCwgZnJvbU1lc3NhZ2UgfTpcclxuICAgICAgICB7IGNoYXRJZDogc3RyaW5nLCBsaW1pdDogbnVtYmVyLCBmcm9tTWVzc2FnZTogc3RyaW5nIH0sXHJcbiAgICAgIHsgdXNlciB9OiB7IHVzZXI6IHN0cmluZyB9XHJcbiAgICApID0+IHtcclxuICAgICAgY29uc3QgY2hhdCA9IChhd2FpdCBDaGF0LmZpbmRDaGF0KHsgX2lkOiBjaGF0SWQgfSkpXHJcbiAgICAgICAgLnVzZXJJbk1lbWJlcnModXNlcilcclxuXHJcbiAgICAgIGNvbnN0IGdldE9mZnNldCA9IGFzeW5jICgpID0+IHtcclxuICAgICAgICBjb25zdCBtZXNzYWdlcyA9IGF3YWl0IE1lc3NhZ2UuZmluZCh7IGNoYXRJZCB9KVxyXG4gICAgICAgICAgLnNvcnQoeyBjcmVhdGVkQXQ6IC0xIH0pXHJcblxyXG4gICAgICAgIGNvbnN0IGlkeCA9IG1lc3NhZ2VzLmZpbmRJbmRleCgobWVzc2FnZTogTWVzc2FnZURvY3VtZW50KSA9PiBtZXNzYWdlLl9pZC50b1N0cmluZygpID09PSBmcm9tTWVzc2FnZSlcclxuXHJcbiAgICAgICAgaWYgKGlkeCA9PT0gLTEpIHRocm93IG5ldyBBcG9sbG9FcnJvcihcIlwiKVxyXG5cclxuICAgICAgICByZXR1cm4gaWR4ICsgMVxyXG4gICAgICB9XHJcblxyXG4gICAgICBjb25zdCBvZmZzZXQgPSBmcm9tTWVzc2FnZSA/IGF3YWl0IGdldE9mZnNldCgpIDogMFxyXG5cclxuICAgICAgY29uc3QgbWVzc2FnZXMgPSBhd2FpdCBNZXNzYWdlLmZpbmQoeyBjaGF0SWQgfSlcclxuICAgICAgICAuc29ydCh7IGNyZWF0ZWRBdDogLTEgfSlcclxuICAgICAgICAubGltaXQobGltaXQpXHJcbiAgICAgICAgLnNraXAob2Zmc2V0KVxyXG5cclxuICAgICAgcmV0dXJuIG1lc3NhZ2VzLnNvcnQoKGEsIGIpID0+IE51bWJlcihhLmNyZWF0ZWRBdCkgLSBOdW1iZXIoYi5jcmVhdGVkQXQpKVxyXG4gICAgfSxcclxuICB9LFxyXG4gIE11dGF0aW9uOiB7XHJcbiAgICBzZW5kTWVzc2FnZTogYXN5bmMgKHJvb3QsIGFyZ3M6IGFueSwgeyB1c2VyIH06IHsgdXNlcjogc3RyaW5nIH0pID0+IHtcclxuICAgICAgY29uc3QgbWVzc2FnZSA9IGF3YWl0IE1lc3NhZ2UuY3JlYXRlKHtcclxuICAgICAgICAuLi5hcmdzLFxyXG4gICAgICAgIHNlbmRlcjogdXNlcixcclxuICAgICAgICB2aWV3ZWRCeTogW3VzZXJdXHJcbiAgICAgIH0pXHJcblxyXG4gICAgICBwdWJzdWIucHVibGlzaChNRVNTQUdFX1NVQlNDUklQVElPTlMuQURELCB7IHR5cGU6ICdBREQnLCBtZXNzYWdlIH0pXHJcblxyXG4gICAgICByZXR1cm4gbWVzc2FnZVxyXG4gICAgfSxcclxuICAgIGRlbGV0ZU1lc3NhZ2U6IGFzeW5jIChyb290LCB7IGlkIH06IHsgaWQ6IHN0cmluZyB9LCB7IHVzZXIgfTogeyB1c2VyOiBzdHJpbmcgfSkgPT4ge1xyXG4gICAgICBjb25zdCBtZXNzYWdlID0gKGF3YWl0IE1lc3NhZ2UuZmluZE1lc3NhZ2UoeyBfaWQ6IGlkIH0pKVxyXG4gICAgICAgIC5oYXZlU2VuZGVyQWxsb3codXNlcilcclxuXHJcbiAgICAgIGF3YWl0IE1lc3NhZ2UuZGVsZXRlT25lKHsgX2lkOiBpZCB9KVxyXG5cclxuICAgICAgcHVic3ViLnB1Ymxpc2goTUVTU0FHRV9TVUJTQ1JJUFRJT05TLkRFTEVURSwgeyB0eXBlOiAnREVMRVRFJywgbWVzc2FnZSB9KVxyXG5cclxuICAgICAgcmV0dXJuIG1lc3NhZ2VcclxuICAgIH0sXHJcbiAgICB1cGRhdGVNZXNzYWdlOiBhc3luYyAoXHJcbiAgICAgIHJvb3QsXHJcbiAgICAgIHsgaWQsIGJvZHkgfTpcclxuICAgICAgICB7IGlkOiBzdHJpbmcsIGJvZHk6IHN0cmluZyB9LFxyXG4gICAgICB7IHVzZXIgfTogeyB1c2VyOiBzdHJpbmcgfVxyXG4gICAgKSA9PiB7XHJcbiAgICAgIGNvbnN0IG1lc3NhZ2UgPSAoYXdhaXQgTWVzc2FnZS5maW5kTWVzc2FnZSh7IF9pZDogaWQgfSkpLmhhdmVTZW5kZXJBbGxvdyh1c2VyKVxyXG5cclxuICAgICAgY29uc3QgdXBkYXRlZE1lc3NhZ2UgPSBhd2FpdCBNZXNzYWdlLmZpbmRCeUlkQW5kVXBkYXRlKGlkLCB7IGJvZHkgfSwgeyBuZXc6IHRydWUgfSlcclxuXHJcbiAgICAgIHB1YnN1Yi5wdWJsaXNoKE1FU1NBR0VfU1VCU0NSSVBUSU9OUy5VUERBVEUsIHsgdHlwZTogJ1VQREFURScsIG1lc3NhZ2UgfSlcclxuXHJcbiAgICAgIHJldHVybiB1cGRhdGVkTWVzc2FnZVxyXG4gICAgfSxcclxuICAgIG1hcmtBc1JlYWQ6IGFzeW5jIChcclxuICAgICAgcm9vdCxcclxuICAgICAgeyBtZXNzYWdlSWQgfTogeyBtZXNzYWdlSWQ6IHN0cmluZyB9LFxyXG4gICAgICB7IHVzZXIgfTogeyB1c2VyOiBzdHJpbmcgfVxyXG4gICAgKSA9PiB7XHJcbiAgICAgIGF3YWl0IE1lc3NhZ2UudXBkYXRlT25lKHsgX2lkOiBtZXNzYWdlSWQgfSwgeyAkcHVzaDogeyB2aWV3ZWRCeTogdXNlciB9IH0pXHJcblxyXG4gICAgICByZXR1cm4gdHJ1ZVxyXG4gICAgfVxyXG4gIH0sXHJcbiAgTWVzc2FnZToge1xyXG4gICAgc2VuZGVyOiBhc3luYyAobWVzc2FnZTogTWVzc2FnZURvY3VtZW50KSA9PlxyXG4gICAgICAoYXdhaXQgbWVzc2FnZS5wb3B1bGF0ZSgnc2VuZGVyJykuZXhlY1BvcHVsYXRlKCkpLnNlbmRlcixcclxuICAgIGlzVmlld2VkOiAoXHJcbiAgICAgIHsgdmlld2VkQnkgfTogTWVzc2FnZURvY3VtZW50LFxyXG4gICAgICBfLFxyXG4gICAgICB7IHVzZXIgfTogeyB1c2VyOiBzdHJpbmcgfVxyXG4gICAgKSA9PiB2aWV3ZWRCeS5pbmNsdWRlcyh1c2VyKVxyXG4gIH0sXHJcbiAgU3Vic2NyaXB0aW9uOiB7XHJcbiAgICBtZXNzYWdlT2JzZXJ2ZXI6IHtcclxuICAgICAgcmVzb2x2ZTogKHBheWxvYWQpID0+IHBheWxvYWQsXHJcbiAgICAgIHN1YnNjcmliZTogd2l0aEZpbHRlcigoXHJcbiAgICAgICAgcm9vdCxcclxuICAgICAgICB7IHR5cGVzIH06IHsgdHlwZXM6IChrZXlvZiB0eXBlb2YgTUVTU0FHRV9TVUJTQ1JJUFRJT05TKVtdIH1cclxuICAgICAgKSA9PiB7XHJcbiAgICAgICAgY29uc3Qgc3Vic2NyaXB0aW9ucyA9IHR5cGVzLm1hcCh0eXBlID0+IE1FU1NBR0VfU1VCU0NSSVBUSU9OU1t0eXBlXSlcclxuXHJcbiAgICAgICAgcmV0dXJuIHB1YnN1Yi5hc3luY0l0ZXJhdG9yKHN1YnNjcmlwdGlvbnMpXHJcbiAgICAgIH0sXHJcbiAgICAgICAgYXN5bmMgKFxyXG4gICAgICAgICAgeyBtZXNzYWdlIH06IHsgbWVzc2FnZTogTWVzc2FnZURvY3VtZW50IH0sXHJcbiAgICAgICAgICBfLFxyXG4gICAgICAgICAgeyB1c2VyIH06IHsgdXNlcjogc3RyaW5nIH1cclxuICAgICAgICApID0+IHtcclxuICAgICAgICAgIGNvbnN0IHsgbWVtYmVycyB9ID0gYXdhaXQgQ2hhdC5maW5kQ2hhdCh7IF9pZDogbWVzc2FnZS5jaGF0SWQgfSlcclxuICAgICAgICAgIGNvbnN0IGlzTWVtYmVyID0gbWVtYmVycy5zb21lKG1lbWJlciA9PiBtZW1iZXIudG9TdHJpbmcoKSA9PT0gdXNlcilcclxuXHJcbiAgICAgICAgICBjb25zdCB7IHNlbmRlciB9ID0gYXdhaXQgbWVzc2FnZS5wb3B1bGF0ZSgnc2VuZGVyJykuZXhlY1BvcHVsYXRlKClcclxuXHJcbiAgICAgICAgICBjb25zdCBub3RTZW5kZXIgPSBzZW5kZXIuaWQudG9TdHJpbmcoKSAhPT0gdXNlclxyXG5cclxuICAgICAgICAgIHJldHVybiBpc01lbWJlciAmJiBub3RTZW5kZXJcclxuICAgICAgICB9XHJcbiAgICAgIClcclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCBkZWZhdWx0IE1lc3NhZ2VSZXNvbHZlXHJcbiJdfQ==